# 💰 머니 팩트(Money Fact) V3.6.0 - 전체 개발 아키텍처 및 상세 명세서

이 문서는 **Money Fact (Gold Edition)** 어플리케이션의 서버와 클라이언트 로직을 처음부터 끝까지 똑같이 구현할 수 있도록 작성된 기술 가이드입니다. 

---

## 1. 아키텍처 개요
Money Fact는 **Server-Client 하이브리드 모델**을 채택하고 있습니다. 
*   **Server (Intelligence Center)**: 모든 전종목 스캔, 수급 분석, 데이터 스냅샷 생성을 담당합니다.
*   **Client (Mobile Interface)**: 서버의 분석 데이터를 시각화하고, 사용자 전용 종목에 대해서만 보조적으로 API를 호출합니다.

---

## 2. 서버 측 (Server Side - Node.js/Express)

### 2.1 시장 모니터링 및 스캔 전략
서버는 한국 시장의 특성(정규장 + 시간외 거래 + 수급 확정 시간)을 반영하여 동작합니다.
*   **가동 시간**: 평일 08:00 ~ 20:00 (KST).
*   **스캔 프로세스**:
    1.  **Wide Net (1차 필터링)**: 거래량 상위 종목, 외국인/기관 순매집 종목 등 약 200~300개의 후보군을 추출합니다.
    2.  **Fixed Target (고정 타겟)**: 사용자가 지정한 70개의 섹터 종목(`SECTOR_WATCH_STOCKS`)은 후보군 포함 여부와 상관없이 **항상** 딥스캔 대상에 포함됩니다.
    3.  **Deep Scan (심층 분석)**: 선정된 종목들에 대해 KIS API를 통해 최근 20~30일치 투자자 데이터를 가져와 연속 매매(Streak), 평단가(VWAP), 매집 정황 등을 계산합니다.

### 2.2 핵심 분석 알고리즘
1.  **연속 수급(Streak) 분석**:
    *   `idx 0`부터 과거로 역산하며 부호가 바뀌기 전까지의 일수를 합산 (`fStreak`, `iStreak`).
2.  **주요 수급 패턴(6대 패턴)**:
    *   **동반 쌍끌이**: 외인/기관 동시 연속 매수 (Streak >= 3).
    *   **변곡점 발생**: 전일 매도에서 당일 매수로 전환.
    *   **히든 매집**: 주가 변동폭은 작으나(<2%) 수급이 집중되는 구간.
3.  **투자 심리 온도계(Market Sentiment)**:
    *   전체 스캔 종목의 수급 합계를 기반으로 온도를 산출 (매수세 우위 시 상승).

### 2.3 주요 API 엔드포인트
*   `GET /api/snapshot`: 현재 시장의 전체 분석 데이터(Candidate List, Sectors, Market Sentiment)를 1~2초 내에 반환합니다.
*   `POST /api/backup-favorites`: 사용자의 관심종목 및 설정을 Firebase와 연동하여 백업합니다.

---

## 3. 클라이언트 측 (Mobile Side - React Native/Expo)

### 3.1 하이브리드 데이터 로딩 전략 (V3.6.0 핵심)
속도 제한(Rate Limit)을 피하고 로딩 속도를 극대화하기 위해 3단계 로딩 시스템을 사용합니다.
1.  **1단계: 로컬 캐시 (즉각성)**
    *   앱 실행 시 `AsyncStorage`에 저장된 지난번 데이터를 즉시 표시 (0.1초).
2.  **2단계: 서버 스냅샷 (신선도)**
    *   서버의 `/api/snapshot`을 호출하여 70개의 섹터 종목 및 주요 종목 데이터를 일괄 업데이트 (1~2초).
3.  **3단계: 실시간 API 호출 (정밀도)**
    *   서버 스냅샷에 없는 사용자의 개인 관심종목에 대해서만 KIS API를 직접 호출.
    *   **이점**: API 호출 횟수를 90% 이상 절감하여 안정성 확보.

### 3.2 실시간 업데이트 로직
*   **주기**: 장중(08:00~20:00) 30초마다 자동 새로고침.
*   **속도 제한**: KIS API 직접 호출 시 500ms의 딜레이(`setTimeout`)를 부여하여 안정성을 보장합니다.

---

## 4. 데이터베이스 및 푸시 시스템 (Firebase)

### 4.1 백업 시스템
*   사용자의 닉네임(고유키)을 문서 ID로 하여 `AsyncStorage` 데이터를 Firebase Realtime Database(또는 Firestore)에 저장합니다.
*   기기 변경 시 해당 고유키만으로 데이터를 완벽 복구합니다.

### 4.2 스마트 푸시 알림
*   **서버 사이드 체크**: 서버는 딥스캔 중 '이탈 신호'나 '강력 매수' 신호가 발생하면 등록된 사용자의 푸시 토큰으로 알림을 보냅니다.
*   **Expo Notifications**: 클라이언트는 Push Token을 서버에 등록하고 수신을 관리합니다.

---

## 5. 설정 및 빌드 환경 (Setup Guide)

### 5.1 서버 환경 변수 (.env)
```env
PORT=3000
KIS_API_KEY=발급받은키
KIS_API_SECRET=발급받은비밀키
KIS_CAN_USE_REALTIME=true (실전투자 여부)
SERVER_PUSH_SENDER_ID=Firebase발급ID
```

### 5.2 클라이언트 환경 변수 (Config.js)
```javascript
export const SERVER_URL = 'http://your-server-ip:3000';
export const KIS_CONFIG = {
  APP_KEY: '발급받은키',
  APP_SECRET: '발급받은비밀키'
};
// 섹터 종목 70개 상세 리스트 포함 (SectorData.js)
```

### 5.3 빌드 가이드
1.  **Android 빌드**: `mobile/android` 폴더에서 `./gradlew assembleRelease` 실행.
2.  **버전 관리**: 신규 버전 배포 시 `app.json`, `build.gradle`, `App.js` 내 버전 정보를 반드시 동기화합니다.

---

## 6. 결론
이 아키텍처는 **서버의 강력한 분석력**과 **클라이언트의 빠른 응답성**을 결합한 최적의 주식 분석 시스템입니다. 특히 V3.6.0에서 구현된 **스냅샷 기반 하이브리드 로딩**은 다수의 사용자가 동시에 사용하더라도 API 제한 없이 안정적인 서비스를 제공할 수 있도록 설계되었습니다.
