# 💰 머니 팩트(Money Fact) V3.8.0 - 전체 개발 아키텍처 및 상세 명세서

이 문서는 **Money Fact (Premium Edition)** 어플리케이션의 서버와 클라이언트 로직을 처음부터 끝까지 똑같이 구현할 수 있도록 작성된 기술 가이드입니다. 

---

## 1. 아키텍처 개요
Money Fact는 **Server-Client 하이브리드 모델**을 채택하고 있습니다. 
*   **Server (Intelligence Center)**: 모든 전종목 스캔, 수급 분석, 데이터 스냅샷 생성을 담당하며 약 15분마다 정밀 분석을 수행합니다.
*   **Client (Mobile Interface)**: 서버의 분석 데이터를 시각화하고, 사용자 전용 종목에 대해서만 보조적으로 API를 호출합니다.

---

## 2. 서버 측 (Server Side - Node.js/Express)

### 2.1 하이브리드 레이더 스캔 전략 (3단계)
서버는 한국 시장의 특성을 반영하여 전 종목을 다단계로 필터링하여 부하를 줄이면서도 정확도를 높입니다.
1.  **와이드 스캔 (Wide Scan)**: 국내 상장된 약 2,800여 개의 전 종목을 1초 단위로 모니터링하여 시세 변동 및 거래량 이상 징후를 1차 필터링합니다.
2.  **후보군 압축 (Candidate Filter)**: 거래량 터진 종목, 주요 섹터(70개), 사용자 관심 종목 등을 결합하여 정밀 분석 대상을 압축합니다.
3.  **심층 분석 (Deep Analysis)**: 선정된 종목들에 대해 증권사 API를 통해 최근 20~30일치 투자자 데이터를 가져와 연속 매매(Streak), 평단가(VWAP), 매집 정황 등을 계산합니다. (장중 약 15분 주기)

### 2.2 핵심 분석 알고리즘
1.  **연속 수급(Streak) 분석**:
    *   `idx 0`부터 과거로 역산하며 부호가 바뀌기 전까지의 일수를 합산 (`fStreak`, `iStreak`).
2.  **주요 수급 패턴(6대 패턴)**:
    *   **동반 쌍끌이**: 외인/기관 동시 연속 매수 (Streak >= 3).
    *   **변곡점 발생**: 전일 매도에서 당일 매수로 전환.
    *   **히든 매집 (매집 의심 종목)**: 
        *   **횡보 감지**: 최근 5거래일 동안의 하루 주가 변동폭(고가-저가/종가)이 평균 **3% 미만**인 종목.
        *   **수급 집중**: 주가는 고요하나 외인 또는 기관의 매수 Streak이 설정된 임계치(기본 3일/5일) 이상인 경우.
3.  **세력 평단가 (VWAP - Volume Weighted Average Price)**:
    *   단순 평균이 아닌 **거래량 가중 평균 가격**을 산출.
    *   **가변 기간 적용**: 사용자가 앱 설정에서 지정한 '매수 포착 기준일'(2~30일)에 따라 계산 시간축이 동적으로 변경됨.
4.  **섹터별 자금 흐름 (Sector Flow)**:
    *   **계산 방식**: 해당 섹터 내 종목들의 `외국인 순매수 + 기관 순매수` 합산 데이터 기준 (개인 제외).
    *   내부적으로 절대값(`Math.abs`) 기준 상위 6개를 추출하여 시장에서 가장 돈이 격렬하게 움직이는 곳을 표기.

---

## 3. 클라이언트 측 (Mobile Side - React Native/Expo)

### 3.1 하이브리드 데이터 로드 및 동기화 상태 표시
1.  **3단계 로딩 시스템**: 로컬 캐시 -> 서버 스냅샷 -> 보조 실시간 API 호출 순으로 데이터 처리.
2.  **동기화 상태 시각화 (MarketStatusHeader)**:
    *   **서버 시각 (확정)**: `Server` 아이콘과 함께 표시. 서버가 마지막으로 전종목 분석을 마친 데이터의 생성 기준 시점.
    *   **휴대폰 시각 (동기화)**: `Smartphone` 아이콘과 함께 표시. 내 휴대폰이 서버와 마지막으로 통신에 성공하여 데이터를 받아온 시점.

### 3.2 실시간 업데이트 및 푸시 전략
*   **주기**: 앱 활성 상태에서 15분마다 조용히(Silent) 서버 스냅샷을 갱신.
*   **배경 모드**: `expo-background-fetch`를 통해 앱이 꺼져있을 때도 주기적으로 중요 수급 변화를 체크하여 로컬 알림을 생성.

---

## 4. 디자인 시스템 및 UX 정책
1.  **가독성 최우선**: 좁은 화면에서도 텍스트가 잘리지 않도록 `adjustsFontSizeToFit` 및 `minimumFontScale`(최소 0.4)을 적극 활용.
2.  **색상 정책**: 
    *   **🔴 빨간색**: 자금 유입(순매수), 상승, 세력보다 비싼 구간.
    *   **🔵 파란색**: 자금 유출(순매도), 하락, 세력보다 저렴한 구간.

---

## 5. 업데이트 히스토리
*   **v3.8.0**: 섹터별 자금 흐름 정렬 로직 개선 (절대값 기준 자동 정렬), 소스 최적화 및 불필요한 로그 제거, 히든 매집 감지 로직(횡보+수급) 정교화.
*   **v3.7.0**: 하이브리드 레이더 엔진 고도화 및 UI 개선.

## 6. 결론
이 문서는 V3.8.0 기준으로 최종 업데이트되었습니다. 본 아키텍처의 핵심은 **서버의 정밀한 3단계 스캔 엔진**과 **클라이언트의 가변적 VWAP 계산 로직**을 결합하여, 사용자에게 가장 신뢰도 높은 '세력의 흔적'을 실시간으로 제공하는 데 있습니다.
